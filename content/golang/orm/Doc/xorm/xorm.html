<!DOCTYPE html>
<html>
<head>
<title>xorm</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<style type="text/css">
/* Solarized (Dark) */
/* Authors: Ethan Schoonover: http://ethanschoonover.com/solarized, CodeCatalyst: http://codecatalyst.com/ */
/* Version: d9a83f4e7a47432baff86e1e7946d9e066cf3d1b (modified) */
/* https://github.com/CodeCatalyst/mou-theme-solarized */

html,
body,
h1,
h2,
h3,
h4,
h5,
h6,
p,
blockquote,
ol,
ul,
li,
img {
  margin: 0;
  padding: 0;
  font-size: 100%;
  font: inherit;
  vertical-align: baseline;
}
html * {
  font-family: "ff-din-web-pro-1", "ff-din-web-pro-2", sans-serif;
  font-size: 16px;
  line-height: 19.2px;
  color-profile: sRGB;
}
body {
  min-width: 32em;
  max-width: 52em;
  margin: 10px;
}
p {
  font-weight: lighter;
  margin-bottom: 20px;
}
strong {
  font-weight: bold;
}
ol,
ul {
  margin-left: 2em;
  margin-bottom: 20px;
}
ul ul,
ol ol,
ul ol,
ol ul {
  margin-top: 10px;
}
li {
  margin-bottom: 10px;
}
h1,
h2,
h3,
h4,
h5,
h6 {
  font-weight: lighter;
  text-transform: capitalize;
  margin-top: 20px;
  margin-bottom: 20px;
}
h1 {
  font-size: 24.624px;
  line-height: 29.548799999999996px;
}
h2 {
  font-size: 24.624px;
  line-height: 29.548799999999996px;
}
h3 {
  font-size: 23.44px;
  line-height: 28.128px;
}
h4 {
  font-size: 22.16px;
  line-height: 26.592px;
}
h5 {
  font-size: 22.16px;
  line-height: 26.592px;
}
h6 {
  font-size: 22.16px;
  line-height: 26.592px;
}
img {
  margin-bottom: 20px;
}
h1 img,
h2 img,
h3 img,
h4 img,
h5 img,
h6 img,
p img {
  margin-bottom: 0;
}
pre {
  margin-bottom: 20px;
}
pre,
code {
  font-family: monospace;
}
pre {
  white-space: pre;
  white-space: pre-wrap;
  word-wrap: break-word;
  padding: 15px;
}
h1 {
  text-transform: uppercase;
  font-weight: bold;
  border-bottom: 1px solid;
}
h2 {
  border-bottom: 1px solid;
}
h3,
h4,
h5,
h6 {
  border-bottom: none;
}
html * {
  color: #839496;
}
html body {
  background-color: #002b36;
}
html h1,
html h2,
html h3,
html h4,
html h5,
html h6 {
  color: #93a1a1;
  border-color: #839496;
}
html a,
html a:active,
html a:visited {
  color: #93a1a1;
}
html a:hover {
  background-color: #073642;
}
html pre {
  color: #93a1a1;
  background-color: #073642;
}
html a,
html a:active,
html a:visited,
html code.url {
  color: #b58900;
}
html h1 {
  color: #b58900;
}
html h2,
html h3,
html h4,
html h5,
html h6 {
  color: #b58900;
}

/*
LICENSE

Solarized Theme for Mou

Copyright (c) 2012 CodeCatalyst, LLC

Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

Solarized

Copyright (c) 2011 Ethan Schoonover

Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
*/
</style>
</head>
<body>
<h1><img src="./favicon.png" /><a href="http://www.xorm.io/">XORM使用整理</a></h1>
<h2>简介</h2>
<p>xorm是一个简单而强大的Go语言ORM库. 通过它可以使数据库操作非常简便。xorm的目标并不是让你完全不去学习SQL，我们认为SQL并不会为ORM所替代，但是ORM将可以解决绝大部分的简单SQL需求。xorm支持两种风格的混用。</p>
<p>特性</p>
<ul>
<li>支持Struct和数据库表之间的灵活映射，并支持自动同步表结构</li>
<li>事务支持</li>
<li>支持原始SQL语句和ORM操作的混合执行</li>
<li>使用连写来简化调用</li>
<li>支持使用Id, In, Where, Limit, Join, Having, Table, Sql, Cols等函数和结构体等方式作为条件</li>
<li>支持级联加载Struct</li>
<li>支持LRU缓存(支持memory, memcache, leveldb, redis缓存Store) 和 Redis缓存</li>
<li>支持反转，即根据数据库自动生成xorm的结构体</li>
<li>支持事件</li>
<li>支持created, updated, deleted和version记录版本（即乐观锁）</li>
</ul>
<h2>初始化</h2>
<pre><code>engine, err := xorm.NewEngine(&quot;mysql&quot;, &quot;root:1234@tcp(127.0.0.1:3306)/operation_i_dzz?charset=utf8&quot;)
    if err != nil {
        fmt.Println(err.Error())
        return
    }
</code></pre>

<ul>
<li>每个数据库都需要单独创建一个数据库引擎对象，所以需要在代码中全局保存这个数据库操作对象</li>
<li>xorm每次操作是基于会话操作的，所以虽然它是针对每个数据库都是单独创建的数据库引擎对象，但仍然是协程安全的。</li>
</ul>
<h3>查</h3>
<pre><code>item := make([]*Tt, 0)

if errMsg := engine.Where(&quot;Id=?&quot;, 1).Limit(1, 0).Find(&amp;item); errMsg != nil {
    fmt.Printf(errMsg.Error())
    return
}

fmt.Printf(&quot;name:%v&quot;, item[0].Name)
</code></pre>

<ul>
<li>使用Get, Find, Count, Rows, Iterate作为最终结果的获取</li>
</ul>
<h3>增</h3>
<pre><code>if count, errMsg := engine.Insert(&amp;Tt{
    Id:   3,
    Name: &quot;h3&quot;,
}); errMsg != nil {
    fmt.Println(errMsg.Error())
    return
} else {
    fmt.Println(&quot;数据insert成功，影响记录数:&quot;, count)
}
</code></pre>

<ul>
<li>如果传入的是一个[]*Tt，则会进行批量插入</li>
<li>批量插入会自动生成Insert into table values (),(),()的语句，因此各个数据库对SQL语句有长度限制，因此这样的语句有一个最大的记录数，根据经验测算在150条左右。大于150条后，生成的sql语句将太长可能导致执行失败。因此在插入大量数据时，目前需要自行分割成每150条插入一次。</li>
<li>这里虽然支持同时插入，但这些插入并没有事务关系。因此有可能在中间插入出错后，后面的插入将不会继续。此时前面的插入已经成功，如果需要回滚，请开启事物。</li>
</ul>
<h3>改</h3>
<pre><code>item := &amp;Tt{
    Id:   3,
    Name: &quot;h5&quot;,
}

if count, errMsg := engine.
    Where(&quot;Id=?&quot;, item.Id).And(&quot;Name&lt;&gt;?&quot;, item.Name).
    AllCols().Update(item); errMsg != nil { //// 如果不使用AllCols，则Update只会提交非0值
    fmt.Println(errMsg.Error())
    return
} else {
    fmt.Println(&quot;数据update成功，影响记录数:&quot;, count)
}
</code></pre>

<ul>
<li>使用Update进行更新，但更新条件需要使用相关查询条件组装函数进行指定更新条件</li>
<li>默认情况下，Update只会更新非0值，也就是说，数值0、字符串&quot;&quot;，bool值false都不会默认提交到数据库，除非使用AllCols()指定</li>
</ul>
<h3>删</h3>
<pre><code>if count, errMsg := engine.Where(&quot;Id=?&quot;, 4).Delete(&amp;Tt{}); errMsg != nil {
    fmt.Printf(errMsg.Error())
} else {
    fmt.Println(&quot;数据update成功，影响记录数:&quot;, count)
}
</code></pre>

<ul>
<li>使用delete进行数据删除</li>
<li>Delete中的结构体中，如果存在非0值，则会使非0值作为删除条件</li>
<li>如果需要指定额外的条件，需要使用相关查询条件语句指定</li>
</ul>
<h3>执行原始sql语句</h3>
<pre><code>data := make([]*Tt, 0)

if errMsg := engine.Sql(&quot;select * from Tt&quot;).Find(&amp;data); errMsg != nil {
    fmt.Printf(errMsg.Error())
    return
}

for _, item := range data {
    fmt.Printf(&quot;\r\nId:%v   name:%v&quot;, item.Id, item.Name)
}
</code></pre>

<ul>
<li>使用Sql、Exec进行原始sql语句的执行</li>
</ul>
<h3>事务操作</h3>
<pre><code>session := engine.NewSession()
defer session.Close()

isOk := false
defer func() {
    if isOk {
        session.Commit()
    } else {
        session.Close()
    }
}()

if _, errMsg := session.Insert(&amp;Tt{
    Id:   4,
    Name: &quot;h4&quot;,
}); errMsg != nil {
    fmt.Println(&quot;插入异常：&quot;, errMsg.Error())
    isOk = false
}

if _, errMsg := session.Where(&quot;Id=?&quot;, 3).AllCols().Update(&amp;Tt{
    Id:   3,
    Name: &quot;hh3&quot;,
}); errMsg != nil {
    fmt.Println(&quot;更新异常：&quot;, errMsg.Error())
    isOk = false
}
</code></pre>

<ul>
<li>事务操作需要显式地单独开启一个会话</li>
</ul>
<h2>总结</h2>
<p><strong>优点</strong></p>
<ol>
<li>分离出来的子项目：<a href="https://github.com/go-xorm/core">core</a>能够很方便地对数据库表结构进行解析和数据库类型到go类型的转换</li>
<li>整体来说使用也确实很简单</li>
<li>支持对数据库表结构和数据的导入导出操作</li>
<li>支持读取数据表的结构信息，并提供有类型映射</li>
<li>有对应的命令行代码生成工具，提供数据表到代码的映射，使用tpl作为代码生成模版</li>
</ol>
<p><strong>缺点</strong></p>
<ol>
<li>源码基本没啥注释，很不方便后期维护</li>
<li>数据删除接口Delete使用很不方便，必须要传一个结构体，而删除条件另外指定更实在一点</li>
<li>无基于协程级别的事务操作</li>
<li>需要为每个数据库连接实例单独定义变量，比较麻烦（也是可以接受的）</li>
<li>更新时，如果不指定AllCols()，则只会更新非0值的字段</li>
</ol>
<p><strong>整体来说，没有beego好用；但用来写数据库相关工具一定是上上之选，因为有较完整的数据库结构的读写支持</strong></p>

</body>
</html>
<!-- This document was created with MarkdownPad, the Markdown editor for Windows (http://markdownpad.com) -->
